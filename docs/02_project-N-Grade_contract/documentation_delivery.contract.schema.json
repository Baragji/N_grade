{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://docs-ui-2/contracts/documentation-delivery-v1",
  "title": "DocumentationDeliveryContract",
  "description": "ZERO-TOLERANCE contract for complete, production-grade documentation deliveries. NO HALF-ASSED WORK.",
  "type": "object",
  "properties": {
    "contract_version": { "const": "1.0.0" },
    "intent": { 
      "type": "string",
      "description": "Single-sentence description of what this contract enforces"
    },
    
    "deliverables": {
      "type": "array",
      "description": "List of all files that MUST be delivered with strict quality gates",
      "minItems": 1,
      "items": {
        "type": "object",
        "properties": {
          "file_path": { 
            "type": "string",
            "description": "Absolute or repo-relative path to the deliverable file",
            "minLength": 1
          },
          "file_type": {
            "enum": ["markdown", "json", "csv", "yaml", "python", "shell"],
            "description": "File type for format-specific validation"
          },
          "purpose": {
            "type": "string",
            "description": "What this file achieves (used in validation reports)"
          },
          "quality_gates": {
            "type": "object",
            "description": "MANDATORY quality requirements that MUST pass",
            "properties": {
              "min_lines": {
                "type": "integer",
                "minimum": 1,
                "description": "Minimum line count (HARD REQUIREMENT)"
              },
              "max_lines": {
                "type": "integer",
                "minimum": 1,
                "description": "Maximum line count (prevents padding)"
              },
              "required_sections": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Section headers that MUST exist (regex patterns allowed)"
              },
              "forbidden_patterns": {
                "type": "array",
                "items": { 
                  "type": "object",
                  "properties": {
                    "pattern": { "type": "string", "description": "Regex pattern that MUST NOT appear" },
                    "reason": { "type": "string", "description": "Why this pattern is forbidden" }
                  },
                  "required": ["pattern", "reason"]
                },
                "description": "Patterns that indicate incomplete work (e.g., '(template)', 'TODO', 'TBD')"
              },
              "required_patterns": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "pattern": { "type": "string", "description": "Regex pattern that MUST appear" },
                    "min_occurrences": { "type": "integer", "minimum": 1, "default": 1 },
                    "reason": { "type": "string", "description": "Why this pattern is required" }
                  },
                  "required": ["pattern", "min_occurrences", "reason"]
                },
                "description": "Content that MUST be present (e.g., code examples, metrics)"
              },
              "no_duplicate_sections": {
                "type": "boolean",
                "default": true,
                "description": "Reject if section headers appear multiple times"
              },
              "structural_requirements": {
                "type": "object",
                "properties": {
                  "min_code_blocks": { 
                    "type": "integer", 
                    "minimum": 0,
                    "description": "Minimum number of code blocks required"
                  },
                  "min_tables": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Minimum number of tables required"
                  },
                  "min_lists": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Minimum number of bullet/numbered lists"
                  },
                  "require_toc": {
                    "type": "boolean",
                    "default": false,
                    "description": "Table of contents required for large docs"
                  }
                }
              },
              "json_schema_validation": {
                "type": "object",
                "description": "For JSON deliverables: path to schema file",
                "properties": {
                  "schema_file": { "type": "string" },
                  "strict_mode": { "type": "boolean", "default": true }
                }
              },
              "csv_validation": {
                "type": "object",
                "description": "For CSV deliverables: column and row requirements",
                "properties": {
                  "required_columns": { 
                    "type": "array", 
                    "items": { "type": "string" },
                    "description": "Column headers that MUST exist"
                  },
                  "min_rows": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Minimum data rows (excluding header)"
                  },
                  "no_empty_cells": {
                    "type": "boolean",
                    "default": true,
                    "description": "Reject if any cells are empty"
                  }
                }
              }
            },
            "required": ["min_lines"]
          },
          "dependencies": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Other deliverables this file depends on (paths)"
          },
          "acceptance_criteria": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Human-readable acceptance criteria for manual review"
          }
        },
        "required": ["file_path", "file_type", "purpose", "quality_gates"]
      }
    },

    "cross_file_validations": {
      "type": "array",
      "description": "Validations that span multiple files",
      "items": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "description": { "type": "string" },
          "files": { 
            "type": "array",
            "items": { "type": "string" },
            "description": "List of file paths involved"
          },
          "validation_type": {
            "enum": ["reference_consistency", "data_consistency", "no_contradictions", "completeness_check"]
          },
          "rules": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Specific rules to check (e.g., 'All Function IDs in CSV must appear in Markdown table')"
          }
        },
        "required": ["name", "files", "validation_type", "rules"]
      }
    },

    "execution_constraints": {
      "type": "object",
      "description": "How the work MUST be executed",
      "properties": {
        "max_session_time_hours": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 8,
          "description": "Maximum time allowed (wall-clock)"
        },
        "checkpoint_required": {
          "type": "boolean",
          "default": true,
          "description": "Must save progress every N deliverables"
        },
        "checkpoint_interval": {
          "type": "integer",
          "minimum": 1,
          "default": 5,
          "description": "Save progress every N files"
        },
        "fail_fast": {
          "type": "boolean",
          "default": true,
          "description": "Stop immediately if any quality gate fails"
        },
        "dry_run_required": {
          "type": "boolean",
          "default": true,
          "description": "Must generate preview before writing files"
        },
        "backup_originals": {
          "type": "boolean",
          "default": true,
          "description": "Create .bak files before overwriting"
        }
      },
      "required": ["max_session_time_hours", "fail_fast"]
    },

    "definition_of_done": {
      "type": "object",
      "description": "MANDATORY completion criteria. ALL must be true.",
      "properties": {
        "all_deliverables_present": { 
          "const": true,
          "description": "Every file in 'deliverables' list exists"
        },
        "all_quality_gates_passed": { 
          "const": true,
          "description": "Every quality_gate validation passed"
        },
        "all_cross_file_validations_passed": {
          "const": true,
          "description": "All cross-file checks passed"
        },
        "no_forbidden_patterns_found": {
          "const": true,
          "description": "Zero instances of forbidden patterns (template, TODO, etc.)"
        },
        "manual_review_completed": {
          "type": "boolean",
          "description": "Human reviewer approved (set by validator)"
        },
        "validation_report_generated": {
          "const": true,
          "description": "Machine-readable validation report created"
        }
      },
      "required": [
        "all_deliverables_present",
        "all_quality_gates_passed",
        "all_cross_file_validations_passed",
        "no_forbidden_patterns_found",
        "validation_report_generated"
      ]
    },

    "return_payload": {
      "type": "object",
      "description": "MANDATORY structured output. NO PROSE.",
      "properties": {
        "contract_id": { "type": "string" },
        "execution_summary": {
          "type": "object",
          "properties": {
            "start_time": { "type": "string", "format": "date-time" },
            "end_time": { "type": "string", "format": "date-time" },
            "elapsed_seconds": { "type": "number", "minimum": 0 },
            "deliverables_count": { "type": "integer", "minimum": 0 }
          },
          "required": ["start_time", "end_time", "elapsed_seconds", "deliverables_count"]
        },
        "deliverable_status": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "file_path": { "type": "string" },
              "status": { "enum": ["PASS", "FAIL", "SKIPPED"] },
              "line_count": { "type": "integer", "minimum": 0 },
              "quality_gate_results": {
                "type": "object",
                "properties": {
                  "min_lines": { "type": "boolean" },
                  "max_lines": { "type": "boolean" },
                  "required_sections": { "type": "boolean" },
                  "forbidden_patterns": { "type": "boolean" },
                  "required_patterns": { "type": "boolean" },
                  "no_duplicate_sections": { "type": "boolean" },
                  "structural_requirements": { "type": "boolean" }
                }
              },
              "failures": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "check": { "type": "string" },
                    "expected": { "type": "string" },
                    "actual": { "type": "string" },
                    "severity": { "enum": ["CRITICAL", "ERROR", "WARNING"] }
                  },
                  "required": ["check", "expected", "actual", "severity"]
                }
              }
            },
            "required": ["file_path", "status", "line_count", "quality_gate_results"]
          }
        },
        "cross_file_validation_results": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "validation_name": { "type": "string" },
              "status": { "enum": ["PASS", "FAIL"] },
              "details": { "type": "string" }
            },
            "required": ["validation_name", "status"]
          }
        },
        "definition_of_done_status": {
          "type": "object",
          "properties": {
            "all_deliverables_present": { "type": "boolean" },
            "all_quality_gates_passed": { "type": "boolean" },
            "all_cross_file_validations_passed": { "type": "boolean" },
            "no_forbidden_patterns_found": { "type": "boolean" },
            "validation_report_generated": { "type": "boolean" }
          },
          "required": [
            "all_deliverables_present",
            "all_quality_gates_passed",
            "all_cross_file_validations_passed",
            "no_forbidden_patterns_found",
            "validation_report_generated"
          ]
        },
        "final_verdict": { 
          "enum": ["ACCEPTED", "REJECTED"],
          "description": "ACCEPTED only if ALL DoD criteria are true"
        },
        "rejection_reasons": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of failed checks (empty if ACCEPTED)"
        },
        "validation_report_path": {
          "type": "string",
          "description": "Path to detailed validation report JSON"
        }
      },
      "required": [
        "contract_id",
        "execution_summary",
        "deliverable_status",
        "cross_file_validation_results",
        "definition_of_done_status",
        "final_verdict",
        "validation_report_path"
      ]
    }
  },
  "required": [
    "contract_version",
    "intent",
    "deliverables",
    "execution_constraints",
    "definition_of_done",
    "return_payload"
  ],
  "additionalProperties": false
}